{
	"$schema": "../tmlanguage.json",

	"name": "GM",

	"scopeName": "source.gm",
	"patterns": [
		{
			"description": "the ':' at the first line of the file is legal",
			"match": "\\A:",
			"name": "keyword.control.define.file.gm"
		},
		{
			"include": "#gmlang"
		}
	],

	"repository": {
		"gmlang": {
			"patterns": [
				{
					"include": "#comments"
				},
				{
					"include": "#brackets"
				},
				{
					"include": "#invalids"
				},
				{
					"include": "#constants"
				},
				{
					"include": "#temporaries"
				},
				{
					"include": "#strings"
				}
			]
		},
		"comments": {
			"patterns": [
				{
					"include": "#block-comments"
				},
				{
					"include": "#line-comments"
				},
				{
					"include": "#doc-comments"
				}
			],
			"repository": {
				"block-comments": {
					"begin": "(?<=^|[,({])\\s*(\\[)(?!\\*\\*(?!\\]))",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.comment.block.begin.gm"
						}
					},
					"end": "(\\])",
					"endCaptures": {
						"1": {
							"name": "punctuation.define.comment.block.end.gm"
						}
					},
					"name": "comment.block.gm",
					"patterns": [
						{
							"include": "#strings"
						},
						{
							"include": "#fenced_code_block_gm"
						},
						{
							"include": "#fenced_code_block_unknow"
						},
						{
							"include": "#better-comments"
						},
						{
							"include": "#nested"
						}
					],
					"repository": {
						"nested": {
							"begin": "\\[",
							"end": "\\]",
							"patterns": [
								{
									"include": "#nested"
								}
							]
						}
					}
				},
				"line-comments": {
					"begin": "(;)",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.comment.line.gm"
						}
					},
					"end": "(?=$|(?<=\\s);)",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.comment.line.gm"
						}
					},
					"name": "comment.line.gm",
					"patterns": [
						{
							"include": "#better-comments"
						}
					]
				},
				"doc-comments": {
					"Comment": "be directly adapted from java",
					"_!!!!": "something wrong here",
					"begin": "^\\s*(\\[\\*\\*)(?!\\])",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.comment.doc.begin.gm"
						}
					},
					"end": "(?:\\*[^\\]]*)?(\\*\\])",
					"endCaptures": {
						"1": {
							"name": "punctuation.define.comment.doc.end.gm"
						}
					},
					"name": "comment.doc.gm",
					"patterns": [
						{
							"_wait": "text.html.markdown"
						},
						{
							"begin": "^\\s*\\*(?!\\])",
							"end": "$",
							"patterns": [
								{
									"include": "#better-comments"
								}
							]
						},
						{
							"include": "#strings"
						},
						{
							"match": "@(?:author|deprecated|return|see|serial|since|version)\\b",
							"name": "keyword.comment.doc.gm"
						},
						{
							"match": "(@param)\\s+(\\S+)",
							"captures": {
								"1": {
									"name": "keyword.comment.doc.gm"
								},
								"2": {
									"name": "variable.parameter.java"
								}
							}
						},
						{
							"match": "(?i)(@(?:exception|throws|error))\\s+(\\S+)",
							"captures": {
								"1": {
									"name": "keyword.comment.doc.gm"
								},
								"2": {
									"name": "entity.name.type.class.java"
								}
							}
						},
						{
							"match": "{(@link)\\s+(\\S+)?#([\\w$]+\\s*\\([^\\(\\)]*\\)).*}",
							"captures": {
								"1": {
									"name": "keyword.comment.doc.gm"
								},
								"2": {
									"name": "entity.name.type.class.java"
								},
								"3": {
									"name": "variable.parameter.java"
								}
							}
						}
					]
				},
				"better-comments": {
					"patterns": [
						{
							"match": "(?<=^|\\G)(\\s*(?i:\\+|todo).*?)($|(?<=\\s);)",
							"captures": {
								"1": {
									"name": "comment.todo.gm"
								},
								"2": {
									"name": "punctuation.define.comment.gm"
								}
							}
						},
						{
							"match": "(?<=^|\\G)(\\s*(?i:\\*|note).*?)($|(?<=\\s);)",
							"captures": {
								"1": {
									"name": "comment.note.gm"
								},
								"2": {
									"name": "punctuation.define.comment.gm"
								}
							}
						},
						{
							"match": "(?<=^|\\G)(\\s*(?i:\\?|wait).*?)($|(?<=\\s);)",
							"captures": {
								"1": {
									"name": "comment.wait.gm"
								},
								"2": {
									"name": "punctuation.define.comment.gm"
								}
							}
						},
						{
							"match": "(?<=^|\\G)(\\s*(?i:\\!|warn).*?)($|(?<=\\s);)",
							"captures": {
								"1": {
									"name": "comment.warn.gm"
								},
								"2": {
									"name": "punctuation.define.comment.gm"
								}
							}
						}
					]
				},
				"fenced_code_block_gm": {
					"begin": "(```)(?i:gm)?\\s+",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.embeded.begin.gm"
						}
					},
					"end": "(```)",
					"endCaptures": {
						"1": {
							"name": "punctuation.define.embeded.end.gm"
						}
					},
					"contentName": "meta.embedded.block.gm",
					"patterns": [
						{
							"include": "#gmlang"
						}
					]
				},
				"fenced_code_block_unknow": {
					"begin": "(```)[^\\s]+",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.embeded.begin.gm"
						}
					},
					"end": "(```)",
					"endCaptures": {
						"1": {
							"name": "punctuation.define.embeded.end.gm"
						}
					},
					"contentName": "meta.embedded.block.language",
					"patterns": []
				}
			}
		},
		"brackets": {
			"patterns": [
				{
					"include": "#round-brackets"
				},
				{
					"include": "#square-brackets"
				},
				{
					"include": "#curly-brackets"
				},
				{
					"include": "#lock-keywords"
				},
				{
					"Comment": "the name is undetermined now",
					"include": "#locator"
				}
			],
			"repository": {
				"round-brackets": {
					"begin": "\\(",
					"beginCaptures": {
						"0": {
							"name": "punctuation.define.sequence.begin.gm"
						}
					},
					"end": "\\)",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.sequence.end.gm"
						}
					},
					"name": "meta.structure.sequence.gm",
					"patterns": [
						{
							"include": "#gmlang"
						}
					]
				},
				"square-brackets": {
					"begin": "(?<!^|,)\\s*(\\[)(?!\\*\\*)",
					"beginCaptures": {
						"1": {
							"name": "punctuation.define.subscript.begin.gm"
						}
					},
					"end": "\\]",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.subscript.end.gm"
						}
					},
					"name": "meta.structure.subscript.gm",
					"patterns": [
						{
							"include": "#gmlang"
						}
					]
				},
				"curly-brackets": {
					"begin": "\\{",
					"beginCaptures": {
						"0": {
							"name": "punctuation.define.set.begin.gm"
						}
					},
					"end": "\\}",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.set.end.gm"
						}
					},
					"name": "meta.structure.set.gm",
					"patterns": [
						{
							"include": "#gmlang"
						},
						{
							"Comment": "I don't know whether I will use this symbol later",
							"match": "\\|",
							"name": "punctuation.separator.gm"
						}
					]
				},
				"lock-keywords": {
					"Comment": "make the keyword 'locked', do not return directly",
					"begin": "&",
					"beginCaptures": {
						"0": {
							"name": "punctuation.lock_symbol.begin.gm"
						}
					},
					"end": "&|(?:(?<!\\\\)$)",
					"endCaptures": {
						"0": {
							"name": "punctuation.lock_symbol.end.gm"
						}
					},
					"patterns": [
						{
							"include": "#gmlang"
						}
					]
				},
				"locator": {
					"begin": "(@)([^\\s,;:@]+)(?:\\.[^\\s,;:@]+)*(,)",
					"beginCaptures": {
						"1": {
							"name": "keyword.control.locator.gm"
						},
						"2": {
							"name": "constant.other.location.gm"
						},
						"3": {
							"name": "punctuation.separator.gm"
						}
					},
					"end": "■",
					"endCaptures": {
						"0": {
							"name": "keyword.control.terminator.gm"
						}
					},
					"patterns": [
						{
							"include": "#gmlang"
						}
					]
				}
			}
		},
		"invalids": {
			"patterns": [
				{
					"name": "invalid.illegal.define.gm",
					"match": "(?<=^|\\s|:):",
					"Comment": "except the : at the beginning of the file"
				},
				{
					"name": "invalid.illegal.quantifier.gm",
					"match": "\\w+[∀∃!]"
				},
				{
					"name": "invalid.illegal.package.gm",
					"match": "(?<=^|,|\\.)\\s*\\."
				},
				{
					"name": "invalid.deprecated.triple.gm",
					"match": "```",
					"Comment": "it can be only used in the comments. In fact you can define it."
				},
				{
					"name": "invalid.deprecated.tab.gm",
					"match": "[^\t$]\t+",
					"Comment": "Tabs should be always at the beginning of new lines"
				}
			]
		},
		"constants": {
			"patterns": [
				{
					"include": "#keywords"
				},
				{
					"include": "#functions"
				},
				{
					"include": "#attributions"
				},
				{
					"name": "constant.other.color.gm",
					"match": "#(?:(?:[0-9a-fA-F]{3}){1,2}|(?:[0-9a-fA-F]{4}){1,2})\\b"
				}
			],
			"repository": {
				"keywords": {
					"patterns": [
						{
							"name": "delimiter.gm",
							"match": " |^\t+"
						},
						{
							"name": "punctuation.separator.gm",
							"match": ","
						},
						{
							"name": "keyword.control.flow.gm",
							"match": "(?:⇒|⇔|⇐)(?!:)"
						},
						{
							"name": "keyword.control.define.gm",
							"match": ":"
						}
					]
				},
				"functions": {
					"patterns": [
						{
							"Comment": "I cannot find a perfect way to deal with this question up to now",
							"match": "[∀∃!](?![^:]*:)",
							"name": "entity.name.function.logical.gm"
						}
					]
				},
				"attributions": {
					"Comment": "be directly adapted from java",
					"patterns": [
						{
							"match": "\\b[^\\s,:;(){}\\[\\]&.|]+(?=\\s*\\.\\s*[^\\s,:;(){}\\[\\]&.|]+)",
							"name": "constant.other.location.gm"
						},
						{
							"Comment": "add an invalid situation",
							"match": "(\\.)\\s*([^\\s,:;(){}\\[\\]&.|]+)",
							"captures": {
								"1": {
									"name": "punctuation.package.gm"
								},
								"2": {
									"name": "constant.other.location.gm"
								}
							}
						}
					]
				}
			}
		},
		"temporaries": {
			"Comment-begin": "undetermined whether the \\s should be forbidden after ∀∃!",
			"begin": "([∀∃!])(?![:.])",
			"beginCaptures": {
				"1": {
					"Comment": "not a keyword",
					"name": "keyword.quantifier.gm"
				}
			},
			"end": "(?<!\\s):",
			"endCaptures": {
				"0": {
					"name": "keyword.control.define.gm"
				}
			},
			"Comment-contentName": "not a variable",
			"contentName": "variable.temporary.define.gm",
			"patterns": [
				{
					"include": "#gmlang"
				}
			]
		},
		"strings": {
			"patterns": [
				{
					"include": "#line-strings"
				},
				{
					"include": "#pre-strings"
				}
			],
			"repository": {
				"line-strings": {
					"Comment": "copy from the python source file",
					"name": "string.quoted.line.gm",
					"begin": "\"",
					"beginCaptures": {
						"0": {
							"name": "punctuation.define.string.line.begin.gm"
						}
					},
					"end": "\"|(?:(?<!\\\\)$)",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.string.line.end.gm"
						}
					},
					"patterns": [
						{
							"name": "constant.character.escape.gm",
							"match": "\\\\."
						}
					]
				},
				"pre-strings": {
					"Comment": "no escape_character in it, which means it cannot includes '`'",
					"name": "string.quoted.pre.gm",
					"begin": "(?<!`)`(?!`)",
					"beginCaptures": {
						"0": {
							"name": "punctuation.define.string.pre.begin.gm"
						}
					},
					"end": "(?<!`)`(?!`)",
					"endCaptures": {
						"0": {
							"name": "punctuation.define.string.pre.end.gm"
						}
					},
					"patterns": []
				}
			}
		}
	}
}
